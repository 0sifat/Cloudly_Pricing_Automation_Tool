name: Deploy PrintManzil Frontend

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set deployment directory
        run: echo "DEPLOY_DIR=/home/ubuntu/actions-runner" >> $GITHUB_ENV
      
      - name: Copy files to deployment directory
        run: |
          set -e
          echo "Copying latest code to deployment directory..."
          # Copy all files except .git directory
          rsync -av --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env.local' \
            --exclude='.env' \
            ./ ${{ env.DEPLOY_DIR }}/
          echo "Files copied successfully"
      
      - name: Build and deploy with Docker Compose
        run: |
          set -e
          cd ${{ env.DEPLOY_DIR }}
          echo "Building and starting containers..."
          docker compose up -d --build
      
      - name: Clean up Docker resources
        run: |
          echo "Cleaning up unused Docker images..."
          docker image prune -f || true
      
      - name: Verify deployment
        run: |
          cd ${{ env.DEPLOY_DIR }}
          echo "Checking container status..."
          docker compose ps
      
      - name: Deployment summary
        if: success()
        run: |
          echo "✅ Deployment completed successfully!"
          echo "Timestamp: $(date)"
      
      - name: Deployment failed
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "Please check the logs above for errors."
          exit 1
